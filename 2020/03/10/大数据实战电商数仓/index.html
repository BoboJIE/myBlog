<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>大数据实战电商数仓 | 球杰の个人博客</title><meta name="description" content="大数据实战电商数仓"><meta name="author" content="球杰"><meta name="copyright" content="球杰"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/myblog/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="大数据实战电商数仓"><meta name="twitter:description" content="大数据实战电商数仓"><meta name="twitter:image" content="https://qiujie219.gitee.io/myblog/img/大数据实战电商数仓/cover.jpg"><meta property="og:type" content="article"><meta property="og:title" content="大数据实战电商数仓"><meta property="og:url" content="https://qiujie219.gitee.io/myblog/2020/03/10/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/"><meta property="og:site_name" content="球杰の个人博客"><meta property="og:description" content="大数据实战电商数仓"><meta property="og:image" content="https://qiujie219.gitee.io/myblog/img/大数据实战电商数仓/cover.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/myblog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://qiujie219.gitee.io/myblog/2020/03/10/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/"><link rel="prev" title="数据仓库" href="https://qiujie219.gitee.io/myblog/2020/03/10/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/"><link rel="next" title="MySQL" href="https://qiujie219.gitee.io/myblog/2020/03/10/MySQL/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/myblog/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/myblog/">球杰の个人博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/myblog/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/myblog/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/myblog/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/myblog/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/myblog/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/myblog/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/myblog/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/myblog/archives/"><div class="headline">文章</div><div class="length_num">15</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/myblog/tags/"><div class="headline">标签</div><div class="length_num">24</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/myblog/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/myblog/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/myblog/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/myblog/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/myblog/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/myblog/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/myblog/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#数据仓库"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">数据仓库</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#项目需求"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">项目需求</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#技术选型"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">技术选型</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#架构"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">架构</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#框架版本选型"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">框架版本选型</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#服务器选型"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">服务器选型</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#物理机"><span class="toc_mobile_items-number">6.1.</span> <span class="toc_mobile_items-text">物理机</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#云主机"><span class="toc_mobile_items-number">6.2.</span> <span class="toc_mobile_items-text">云主机</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#日志生成代码"><span class="toc_mobile_items-number">7.</span> <span class="toc_mobile_items-text">日志生成代码</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#集群搭建"><span class="toc_mobile_items-number">8.</span> <span class="toc_mobile_items-text">集群搭建</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#编写集群分发脚本xsync"><span class="toc_mobile_items-number">9.</span> <span class="toc_mobile_items-text">编写集群分发脚本xsync</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#配置集群"><span class="toc_mobile_items-number">10.</span> <span class="toc_mobile_items-text">配置集群</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#项目经验"><span class="toc_mobile_items-number">11.</span> <span class="toc_mobile_items-text">项目经验</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#存储多目录"><span class="toc_mobile_items-number">11.1.</span> <span class="toc_mobile_items-text">存储多目录</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#支持LZO压缩配置"><span class="toc_mobile_items-number">11.2.</span> <span class="toc_mobile_items-text">支持LZO压缩配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#基准测试"><span class="toc_mobile_items-number">11.3.</span> <span class="toc_mobile_items-text">基准测试</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#HDFS参数调优"><span class="toc_mobile_items-number">11.4.</span> <span class="toc_mobile_items-text">HDFS参数调优</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#安装Zookeeper"><span class="toc_mobile_items-number">12.</span> <span class="toc_mobile_items-text">安装Zookeeper</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Flume"><span class="toc_mobile_items-number">13.</span> <span class="toc_mobile_items-text">Flume</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装"><span class="toc_mobile_items-number">13.1.</span> <span class="toc_mobile_items-text">安装</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#测试监控"><span class="toc_mobile_items-number">13.2.</span> <span class="toc_mobile_items-text">测试监控</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Flume组件"><span class="toc_mobile_items-number">13.3.</span> <span class="toc_mobile_items-text">Flume组件</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#流式结构"><span class="toc_mobile_items-number">13.3.1.</span> <span class="toc_mobile_items-text">流式结构</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#null"><span class="toc_mobile_items-number">13.3.2.</span> <span class="toc_mobile_items-text"></span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#Source"><span class="toc_mobile_items-number">13.3.3.</span> <span class="toc_mobile_items-text">Source</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#Channel"><span class="toc_mobile_items-number">13.3.4.</span> <span class="toc_mobile_items-text">Channel</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#配置文件"><span class="toc_mobile_items-number">13.4.</span> <span class="toc_mobile_items-text">配置文件</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#拦截器"><span class="toc_mobile_items-number">13.4.1.</span> <span class="toc_mobile_items-text">拦截器</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Kafka"><span class="toc_mobile_items-number">14.</span> <span class="toc_mobile_items-text">Kafka</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装-1"><span class="toc_mobile_items-number">14.1.</span> <span class="toc_mobile_items-text">安装</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#配置"><span class="toc_mobile_items-number">14.2.</span> <span class="toc_mobile_items-text">配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Kafka-Manager"><span class="toc_mobile_items-number">14.3.</span> <span class="toc_mobile_items-text">Kafka Manager</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Kafka压力测试"><span class="toc_mobile_items-number">14.4.</span> <span class="toc_mobile_items-text">Kafka压力测试</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#Kafka压测"><span class="toc_mobile_items-number">14.4.1.</span> <span class="toc_mobile_items-text">Kafka压测</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Kafka机器数量计算"><span class="toc_mobile_items-number">14.5.</span> <span class="toc_mobile_items-text">Kafka机器数量计算</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#消费Kafka数据Flume"><span class="toc_mobile_items-number">15.</span> <span class="toc_mobile_items-text">消费Kafka数据Flume</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#配置文件-1"><span class="toc_mobile_items-number">15.1.</span> <span class="toc_mobile_items-text">配置文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#日志消费Flume启动停止脚本"><span class="toc_mobile_items-number">15.2.</span> <span class="toc_mobile_items-text">日志消费Flume启动停止脚本</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#采集通道启动-停止脚本"><span class="toc_mobile_items-number">15.3.</span> <span class="toc_mobile_items-text">采集通道启动&#x2F;停止脚本</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Debug"><span class="toc_mobile_items-number">16.</span> <span class="toc_mobile_items-text">Debug</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#hadoop启动后没有datanode"><span class="toc_mobile_items-number">16.1.</span> <span class="toc_mobile_items-text">hadoop启动后没有datanode</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#namenode没启动"><span class="toc_mobile_items-number">16.2.</span> <span class="toc_mobile_items-text">namenode没启动</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据仓库"><span class="toc-number">1.</span> <span class="toc-text">数据仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目需求"><span class="toc-number">2.</span> <span class="toc-text">项目需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#技术选型"><span class="toc-number">3.</span> <span class="toc-text">技术选型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#架构"><span class="toc-number">4.</span> <span class="toc-text">架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#框架版本选型"><span class="toc-number">5.</span> <span class="toc-text">框架版本选型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务器选型"><span class="toc-number">6.</span> <span class="toc-text">服务器选型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#物理机"><span class="toc-number">6.1.</span> <span class="toc-text">物理机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#云主机"><span class="toc-number">6.2.</span> <span class="toc-text">云主机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#日志生成代码"><span class="toc-number">7.</span> <span class="toc-text">日志生成代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群搭建"><span class="toc-number">8.</span> <span class="toc-text">集群搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写集群分发脚本xsync"><span class="toc-number">9.</span> <span class="toc-text">编写集群分发脚本xsync</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置集群"><span class="toc-number">10.</span> <span class="toc-text">配置集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目经验"><span class="toc-number">11.</span> <span class="toc-text">项目经验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#存储多目录"><span class="toc-number">11.1.</span> <span class="toc-text">存储多目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#支持LZO压缩配置"><span class="toc-number">11.2.</span> <span class="toc-text">支持LZO压缩配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基准测试"><span class="toc-number">11.3.</span> <span class="toc-text">基准测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDFS参数调优"><span class="toc-number">11.4.</span> <span class="toc-text">HDFS参数调优</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Zookeeper"><span class="toc-number">12.</span> <span class="toc-text">安装Zookeeper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flume"><span class="toc-number">13.</span> <span class="toc-text">Flume</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">13.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试监控"><span class="toc-number">13.2.</span> <span class="toc-text">测试监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flume组件"><span class="toc-number">13.3.</span> <span class="toc-text">Flume组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#流式结构"><span class="toc-number">13.3.1.</span> <span class="toc-text">流式结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#null"><span class="toc-number">13.3.2.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Source"><span class="toc-number">13.3.3.</span> <span class="toc-text">Source</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Channel"><span class="toc-number">13.3.4.</span> <span class="toc-text">Channel</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置文件"><span class="toc-number">13.4.</span> <span class="toc-text">配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#拦截器"><span class="toc-number">13.4.1.</span> <span class="toc-text">拦截器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka"><span class="toc-number">14.</span> <span class="toc-text">Kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-1"><span class="toc-number">14.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置"><span class="toc-number">14.2.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka-Manager"><span class="toc-number">14.3.</span> <span class="toc-text">Kafka Manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka压力测试"><span class="toc-number">14.4.</span> <span class="toc-text">Kafka压力测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Kafka压测"><span class="toc-number">14.4.1.</span> <span class="toc-text">Kafka压测</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka机器数量计算"><span class="toc-number">14.5.</span> <span class="toc-text">Kafka机器数量计算</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#消费Kafka数据Flume"><span class="toc-number">15.</span> <span class="toc-text">消费Kafka数据Flume</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置文件-1"><span class="toc-number">15.1.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志消费Flume启动停止脚本"><span class="toc-number">15.2.</span> <span class="toc-text">日志消费Flume启动停止脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#采集通道启动-停止脚本"><span class="toc-number">15.3.</span> <span class="toc-text">采集通道启动&#x2F;停止脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Debug"><span class="toc-number">16.</span> <span class="toc-text">Debug</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hadoop启动后没有datanode"><span class="toc-number">16.1.</span> <span class="toc-text">hadoop启动后没有datanode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#namenode没启动"><span class="toc-number">16.2.</span> <span class="toc-text">namenode没启动</span></a></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://qiujie219.gitee.io/myblog/img/大数据实战电商数仓/cover.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">大数据实战电商数仓</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-03-10<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-05-19</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h2 id="数据仓库"><a href="#数据仓库" class="headerlink" title="数据仓库"></a>数据仓库</h2><ul>
<li>数据仓库是为企业所有决策制定过程，提供所有系统数据支持的战略集合</li>
<li>通过对数据仓库中数据的分析，可以帮助企业，改进业务流程、控制成本、提高产品质量等</li>
<li>数据仓库，并不是数据的最终目的地，而是为数据最终的目的最好准备：清洗、转义、分类、重组、合并、拆分、统计等</li>
</ul>
<p><a href="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200310195923160.png" data-fancybox="group" data-caption="image-20200310195923160" class="fancybox"><img alt="image-20200310195923160" title="image-20200310195923160" data-src="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200310195923160.png" class="lazyload"></a></p>
<h2 id="项目需求"><a href="#项目需求" class="headerlink" title="项目需求"></a>项目需求</h2><ul>
<li>数据采集平台搭建</li>
<li>实现用户行为数据仓库的分层搭建</li>
<li>实现业务数据仓库的分层搭建</li>
<li>针对数据仓库中的数据进行：<strong>留存、转化率、GMV、复购率、活跃等报表分析</strong></li>
</ul>
<h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><ul>
<li>数据采集传输：<strong>Flume、Kafka、Sqoop</strong>、Logstash、DataX</li>
<li>数据存储：<strong>MySQL、HDFS</strong>、HBase、Redis、MongoDB</li>
<li>数据计算：<strong>Hive、Tez、Spark</strong>、Flink、Storm</li>
<li>数据查询：<strong>Presto、Druid</strong>、Impala、Kylin</li>
</ul>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p><a href="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200311115512582.png" data-fancybox="group" data-caption="image-20200311115512582" class="fancybox"><img alt="image-20200311115512582" title="image-20200311115512582" data-src="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200311115512582.png" class="lazyload"></a></p>
<h2 id="框架版本选型"><a href="#框架版本选型" class="headerlink" title="框架版本选型"></a>框架版本选型</h2><ul>
<li>Apache：运维麻烦，组件间的兼容性需要自己调研，一般大厂使用，技术实力雄厚，有专业的运维人员</li>
<li>CDH：国内使用最多，但不开源</li>
<li>HDP：开源，可二次开发，没有CDH稳定，国内使用少</li>
</ul>
<ol>
<li><p>Apache框架版本</p>
<table>
<thead>
<tr>
<th>产品</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>Hadoop</td>
<td>2.7.2</td>
</tr>
<tr>
<td>Flume</td>
<td>1.7.0</td>
</tr>
<tr>
<td>Kafka</td>
<td>0.11.0.2</td>
</tr>
<tr>
<td>Kafka Manager</td>
<td>1.3.3.22</td>
</tr>
<tr>
<td>Hive</td>
<td>1.2.1</td>
</tr>
<tr>
<td>Sqoop</td>
<td>1.4.6</td>
</tr>
<tr>
<td>MySQL</td>
<td>5.6.24</td>
</tr>
<tr>
<td>Azkaban</td>
<td>2.5.0</td>
</tr>
<tr>
<td>Java</td>
<td>1.8</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>3.4.10</td>
</tr>
<tr>
<td>Presto</td>
<td>0.189</td>
</tr>
</tbody></table>
</li>
</ol>
<ol start="2">
<li>CDH框架版本：5.12.1</li>
</ol>
<table>
<thead>
<tr>
<th>产品</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>Hadoop</td>
<td>2.6.0</td>
</tr>
<tr>
<td>Spark</td>
<td>1.6.0</td>
</tr>
<tr>
<td>Flume</td>
<td>1.6.0</td>
</tr>
<tr>
<td>Hive</td>
<td>1.1.0</td>
</tr>
<tr>
<td>Sqoop</td>
<td>1.4.6</td>
</tr>
<tr>
<td>Oozie</td>
<td>4.1.0</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>3.4.5</td>
</tr>
<tr>
<td>Impala</td>
<td>2.9.0</td>
</tr>
</tbody></table>
<h2 id="服务器选型"><a href="#服务器选型" class="headerlink" title="服务器选型"></a>服务器选型</h2><h3 id="物理机"><a href="#物理机" class="headerlink" title="物理机"></a>物理机</h3><ul>
<li>需要专业的运维人员（月薪15K-30K）</li>
<li>五年左右的使用寿命</li>
<li>128G内存、20核心物理CPU、40线程、8T HDD、2T SSD、戴尔、4W出头</li>
<li>需要考虑托管服务器的费用</li>
</ul>
<h3 id="云主机"><a href="#云主机" class="headerlink" title="云主机"></a>云主机</h3><ul>
<li>阿里云服务器相同配置每年5W左右</li>
<li>省去很多运维的工作</li>
</ul>
<h2 id="日志生成代码"><a href="#日志生成代码" class="headerlink" title="日志生成代码"></a>日志生成代码</h2><ul>
<li><p>创建Maven工程</p>
</li>
<li><p>创建log-collector</p>
</li>
</ul>
<p>依赖</p>
<ul>
<li><p>阿里巴巴开源json解析框架</p>
</li>
<li><p>日志生成框架</p>
</li>
<li><p>编译打包插件</p>
<p>使用Maven自带的工具即可</p>
<p><a href="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200317180019301.png" data-fancybox="group" data-caption="image-20200317180019301" class="fancybox"><img alt="image-20200317180019301" title="image-20200317180019301" data-src="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200317180019301.png" class="lazyload"></a></p>
</li>
</ul>
<p>日志行为数据模拟</p>
<p><a href="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200312111135204.png" data-fancybox="group" data-caption="image-20200312111135204" class="fancybox"><img alt="image-20200312111135204" title="image-20200312111135204" data-src="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200312111135204.png" class="lazyload"></a></p>
<h2 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h2><ul>
<li><p>集群规划</p>
<table>
<thead>
<tr>
<th></th>
<th>服务器hadoop102</th>
<th>服务器hadoop103</th>
<th>服务器hadoop104</th>
</tr>
</thead>
<tbody><tr>
<td>HDFS</td>
<td>NameNode、DataNode</td>
<td>DataNode</td>
<td>DataNode、SecondaryNameNode</td>
</tr>
<tr>
<td>Yarn</td>
<td>NodeManager</td>
<td>Resourcemanager、NodeManager</td>
<td>NodeManager</td>
</tr>
</tbody></table>
</li>
</ul>
<ol>
<li><p>创建虚拟机</p>
<ul>
<li>下载CentOS 6镜像</li>
<li>新建虚拟机</li>
<li>加入镜像</li>
<li>一路下一步</li>
<li>创建完一个虚拟机</li>
<li>右键→管理→克隆→命名成其他名字→完成克隆</li>
</ul>
</li>
<li><p>修改IP地址</p>
<ul>
<li><pre><code class="shell">vim /etc/udev/rules.d/70-persistent-net.rules
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">     ![image-20200312172010033](https:&#x2F;&#x2F;qiujie219.gitee.io&#x2F;myblog&#x2F;img&#x2F;大数据实战电商数仓&#x2F;image-20200312172010033.png)</span><br><span class="line"></span><br><span class="line">3. 修改主机名</span><br><span class="line"></span><br><span class="line">   * &#96;&#96;&#96;shell</span><br><span class="line">     vim &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth0</span><br></pre></td></tr></table></figure></div>

![image-20200312172730111](https://qiujie219.gitee.io/myblog/img/大数据实战电商数仓/image-20200312172730111.png)

* ```shell
  vim /etc/sysconfig/network 
  <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">       ![image-20200312172932698](https:&#x2F;&#x2F;qiujie219.gitee.io&#x2F;myblog&#x2F;img&#x2F;大数据实战电商数仓&#x2F;image-20200312172932698.png)</span><br><span class="line"></span><br><span class="line">       * 每一台虚拟机都需要使用不同的IP地址重复上述操作</span><br><span class="line">       * 静态IP地址设置失败，原因未明，所以暂时用DHCP动态分配的IP地址</span><br><span class="line"></span><br><span class="line">4. Shell登录虚拟机</span><br><span class="line"></span><br><span class="line">   * 文件→新建</span><br><span class="line"></span><br><span class="line">     ![image-20200312191927642](https:&#x2F;&#x2F;qiujie219.gitee.io&#x2F;myblog&#x2F;img&#x2F;大数据实战电商数仓&#x2F;image-20200312191927642.png)</span><br><span class="line"></span><br><span class="line">5. 关闭防火墙</span><br><span class="line"></span><br><span class="line">   &#96;&#96;&#96;shell</span><br><span class="line">   # 关闭iptables </span><br><span class="line">   &#x2F;etc&#x2F;init.d&#x2F;iptables stop </span><br><span class="line">   # 永久关闭 </span><br><span class="line">   chkconfig iptables off</span><br><span class="line">   # 检查 </span><br><span class="line">   chkconfig --list iptables</span><br></pre></td></tr></table></figure></div>


</code></pre>
</li>
</ul>
</li>
</ol>
<ol start="6">
<li><p>创建用户</p>
</li>
<li><p>用户具有root权限</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sudoers/</span><br></pre></td></tr></table></figure></div>

<p>添加</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username ALL=(ALL) ALL</span><br></pre></td></tr></table></figure></div>

<p><strong>注意，余下的过程中请全程使用该用户，否则会导致权限问题，软件在那个用户下安装的就属于哪个用户</strong></p>
</li>
<li><p>配置JDK</p>
<ul>
<li><p>配置rz sz</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y lrzsz</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>虚拟机到达需要安装jdk的目录</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rz</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>弹出界面，选择jdk</p>
<p><a href="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200312211142659.png" data-fancybox="group" data-caption="image-20200312211142659" class="fancybox"><img alt="image-20200312211142659" title="image-20200312211142659" data-src="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200312211142659.png" class="lazyload"></a></p>
</li>
<li><p>解压jdk</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf jdk-8u144-linux-x64.tar.gz -C /opt/module/</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>配置环境变量<strong>（pwd获取当前目录绝对路径）</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/profile</span><br></pre></td></tr></table></figure></div>

<p>进入文件末尾编辑<strong>（yy复制，p粘贴，Ctrl+z跳出，fg返回，Shift+g到文末，gg到文首）</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">JAVA_HOME</span></span><br><span class="line">export JAVA_HOME=/opt/module/jdk1.8.0_144</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br></pre></td></tr></table></figure></div>

<p>source一下</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></div>

<p>检验是否配置成功</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
</li>
<li><p>安装Hadoop</p>
<ul>
<li><p>依然是利用rz上传文件到虚拟机</p>
</li>
<li><p>解压到module</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf hadoop-2.7.2.tar.gz -C /opt/module/</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>配置环境变量</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/profile</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>进入文件末尾添加</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">HADOOP_HOME</span></span><br><span class="line">export HADOOP_HOME=/opt/module/hadoop-2.7.2</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/bin</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/sbin</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>source一下</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>检验一下</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoo -version</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
</li>
</ol>
<h2 id="编写集群分发脚本xsync"><a href="#编写集群分发脚本xsync" class="headerlink" title="编写集群分发脚本xsync"></a>编写集群分发脚本xsync</h2><p>主要用于提高开发效率，循环复制文件到所有节点相同的目录下</p>
<ol>
<li><p>在用户目录（即~目录）创建bin目录，然后在bin目录下创建xsync文件</p>
</li>
<li><p>编写该文件</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1 获取输入参数个数，如果没有参数，直接退出</span></span><br><span class="line">pcount=$#</span><br><span class="line">if((pcount==0)); then</span><br><span class="line">echo no args;</span><br><span class="line">exit;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">2 获取文件名称</span></span><br><span class="line">p1=$1</span><br><span class="line">fname=`basename $p1`</span><br><span class="line">echo fname=$fname</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">3 获取上级目录到绝对路径</span></span><br><span class="line">pdir=`cd -P $(dirname $p1); pwd`</span><br><span class="line">echo pdir=$pdir</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">4 获取当前用户名称</span></span><br><span class="line">user=`whoami`</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">5 循环</span></span><br><span class="line">for((host=103; host&lt;105; host++)); do</span><br><span class="line">        echo ------------------- hadoop$host --------------</span><br><span class="line">        rsync -rvl $pdir/$fname $user@hadoop$host:$pdir</span><br><span class="line">done</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>给该文件提权</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 xsync</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>调用脚本形式</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xsync [file]</span><br></pre></td></tr></table></figure></div>

</li>
</ol>
<h2 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h2><ul>
<li><p><strong>注意：需要完成主机名与IP地址的映射，每个主机都要</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop104 .ssh]$ vim /etc/hosts</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.6.128 hadoop102</span><br><span class="line">192.168.6.129 hadoop103</span><br><span class="line">192.168.6.130 hadoop104</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
<ol>
<li><p>配置core-site.xml</p>
<ul>
<li><p>进入/opt/module/hadoop-2.7.2/etc/hadoop目录编辑core-site.xml</p>
</li>
<li><pre><code class="html">#插入到configuration中
<span class="comment">&lt;!-- 指定HDFS中NameNode的地址 --&gt;</span>
<span class="tag">&lt;<span class="name">property</span>&gt;</span>
        <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
      <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://hadoop102:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span>
<span class="tag">&lt;/<span class="name">property</span>&gt;</span>

<span class="comment">&lt;!-- 指定Hadoop运行时产生文件的存储目录 --&gt;</span>
<span class="tag">&lt;<span class="name">property</span>&gt;</span>
        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/module/hadoop-2.7.2/data/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span>
<span class="tag">&lt;/<span class="name">property</span>&gt;</span>

<span class="comment"><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. 配置hadoop-env.sh</span><br><span class="line"></span><br><span class="line">   * 复制JAVA_HOME的绝对路径&#x2F;opt&#x2F;module&#x2F;jdk1.8.0_144</span><br><span class="line">   * 进入&#x2F;opt&#x2F;module&#x2F;hadoop-2.7.2&#x2F;etc&#x2F;hadoop，vim hadoop-env.sh</span><br><span class="line">   * 利用 “ &#x2F; “ 查找JAVA_HOME（“n”下一个“N”上一个）</span><br><span class="line">   * “ i ” 进入编辑，粘贴绝对路径，保存退出</span><br><span class="line"></span><br><span class="line">3. 配置hdfs-site.xml</span><br><span class="line"></span><br><span class="line">   * vi hdfs-site.xml</span><br><span class="line"></span><br><span class="line">   * &#96;&#96;&#96;html</span><br><span class="line">     &lt;property&gt;</span><br><span class="line">     		&lt;name&gt;dfs.replication&lt;&#x2F;name&gt;</span><br><span class="line">     		&lt;value&gt;3&lt;&#x2F;value&gt;</span><br><span class="line">     &lt;&#x2F;property&gt;</span><br><span class="line">     </span><br><span class="line">     &lt;!-- 指定Hadoop辅助名称节点主机配置 --&gt;</span><br><span class="line">     &lt;property&gt;</span><br><span class="line">           &lt;name&gt;dfs.namenode.secondary.http-address&lt;&#x2F;name&gt;</span><br><span class="line">           &lt;value&gt;hadoop104:50090&lt;&#x2F;value&gt;</span><br><span class="line">     &lt;&#x2F;property&gt;</span><br></pre></td></tr></table></figure></div></span></code></pre>
</li>
</ul>
</li>
<li><p>YARN配置文件</p>
<ul>
<li><p>yarn-env.sh</p>
</li>
<li><p>同1，配置JAVA_HOME</p>
</li>
<li><p>yarn-site.xml</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Reducer获取数据的方式 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 指定YARN的ResourceManager的地址 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop103<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
</li>
</ul>
</li>
<li><p>MapReduce配置</p>
<ul>
<li><p>重命名</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv mapred-site.xml.template mapred-site.xml</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>编辑 mapred-site.xml（使MR运行在Yarn上）</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Reducer获取数据的方式 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 指定YARN的ResourceManager的地址 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop103<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
</li>
</ul>
</li>
<li><p>配置slaves</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hadoop102</span><br><span class="line">hadoop103</span><br><span class="line">hadoop104</span><br></pre></td></tr></table></figure></div>

<p><strong>注意：一个空格一个空行都不允许有</strong></p>
</li>
<li><p>分发</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 module]$ xsync hadoop-2.7.2/</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>配置ssh</p>
<ul>
<li><pre><code class="shell">[qiujie@hadoop102 .ssh]$ ssh-keygen -t rsa
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* &#96;&#96;&#96;shell</span><br><span class="line">  [qiujie@hadoop102 .ssh]$ ssh-copy-id hadoop102</span><br><span class="line">  [qiujie@hadoop102 .ssh]$ ssh-copy-id hadoop103</span><br><span class="line">  [qiujie@hadoop102 .ssh]$ ssh-copy-id hadoop104</span><br></pre></td></tr></table></figure></div></code></pre>
</li>
<li><p>同样因为Yarn在hadoop103上有服务，所以hadoop103同样需要连接各个主机，需要配置ssh</p>
</li>
</ul>
</li>
<li><p>启动hadoop</p>
<ul>
<li><p>格式化Hdfs</p>
<p>进入hadoop软件目录</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop-2.7.2]$ bin/hdfs namenode -format</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>启动</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop-2.7.2]$ sbin/start-dfs.sh</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
</li>
<li><p>启动Yarn</p>
<ul>
<li><p>进入hadoop103主机</p>
</li>
<li><p>进入hadoop目录</p>
</li>
<li><p>启动Yarn</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop103 hadoop-2.7.2]$ sbin/start-yarn.sh</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
</li>
<li><p>检验是否集群启动成功</p>
<p>进入各个主机</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop-2.7.2]$ jps</span><br></pre></td></tr></table></figure></div>

<p>应对应与</p>
</li>
</ol>
<h2 id="项目经验"><a href="#项目经验" class="headerlink" title="项目经验"></a>项目经验</h2><h3 id="存储多目录"><a href="#存储多目录" class="headerlink" title="存储多目录"></a>存储多目录</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop]$ df -h</span><br></pre></td></tr></table></figure></div>

<p>该命令可查看数据存储的物理情况，即存储在哪个硬盘，占用多少。</p>
<p><a href="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200314000649556.png" data-fancybox="group" data-caption="image-20200314000649556" class="fancybox"><img alt="image-20200314000649556" title="image-20200314000649556" data-src="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200314000649556.png" class="lazyload"></a></p>
<ul>
<li>为了避免数据只存储在初始硬盘上导致满盘，需要在hdfs-site.xml中配置多目录</li>
<li>最好提前配置好，否则更改目录需要重新启动集群</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.data.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">value</span>&gt;</span>file:///$&#123;hadoop.tmp.dir&#125;/dfs/data1,file:///hd2/dfs/data2,file:///hd3/dfs/data3,file:///hd4/dfs/data4<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="支持LZO压缩配置"><a href="#支持LZO压缩配置" class="headerlink" title="支持LZO压缩配置"></a>支持LZO压缩配置</h3><ol>
<li><p>下载lzo的jar项目</p>
<ul>
<li><a href="https://github.com/twitter/hadoop-lzo/archive/master.zip" target="_blank" rel="noopener">https://github.com/twitter/hadoop-lzo/archive/master.zip</a></li>
</ul>
</li>
<li><p>maven编译生成hadoop-lzo-0.4.20.jar</p>
<ul>
<li><p>cmd命令窗口进入到maven项目包含pom.xml文件的目录下</p>
</li>
<li><p>执行</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn compile</span><br></pre></td></tr></table></figure></div>
</li>
</ul>
</li>
<li><p>传到share/hadoop/common/</p>
</li>
<li><p>分发</p>
</li>
<li><p>core-site.xml配置</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>io.compression.codecs<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">    org.apache.hadoop.io.compress.GzipCodec,</span><br><span class="line">    org.apache.hadoop.io.compress.DefaultCodec,</span><br><span class="line">    org.apache.hadoop.io.compress.BZip2Codec,</span><br><span class="line">    org.apache.hadoop.io.compress.SnappyCodec,</span><br><span class="line">    com.hadoop.compression.lzo.LzoCodec,</span><br><span class="line">    com.hadoop.compression.lzo.LzopCodec</span><br><span class="line"><span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>io.compression.codec.lzo.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.hadoop.compression.lzo.LzoCodec<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



</li>
</ol>
<ol start="6">
<li><p>分发</p>
</li>
<li><p>启动</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop-2.7.2]$ sbin/start-dfs.sh</span><br><span class="line">[qiujie@hadoop103 hadoop-2.7.2]$ sbin/start-yarn.sh</span><br></pre></td></tr></table></figure></div>



</li>
</ol>
<ol start="8">
<li><p>启动发生错误时</p>
<ul>
<li><p>查看日志</p>
</li>
<li><p>如果进入安全模式，需要离开安全模式</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfsadmin -safemode leave</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>停止所有进程，删除data和log文件夹，然后格式化</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs namenode -format</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
</li>
</ol>
<h3 id="基准测试"><a href="#基准测试" class="headerlink" title="基准测试"></a>基准测试</h3><ol>
<li><p>打开<a href="http://hadoop102:50070/" target="_blank" rel="noopener">http://hadoop102:50070/</a></p>
</li>
<li><p>测试写数据</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 mapreduce]$ hadoop jar /opt/module/hadoop-2.7.2/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-2.7.2-tests.jar TestDFSIO -write -nrFiles 10 -fileSize 128MB</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>测试读数据</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 mapreduce]$ hadoop jar /opt/module/hadoop-2.7.2/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-2.7.2-tests.jar TestDFSIO -read -nrFiles 10 -fileSize 128MB</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>删除测试生成的数据</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 mapreduce]$ hadoop jar /opt/module/hadoop-2.7.2/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-2.7.2-tests.jar TestDFSIO -clean</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>使用Sort程序评测MapReduce</p>
<ul>
<li><p>使用RandomWriter来产生随机数，每个节点运行10个Map任务，每个Map产生大约1G大小的二进制随机数</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop102 mapreduce]$ hadoop jar /opt/module/hadoop-2.7.2/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.2.jar randomwriter random-data</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>执行Sort程序</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 mapreduce]$ hadoop jar /opt/module/hadoop-2.7.2/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.2.jar sort random-data sorted-data</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>验证数据是否真正排好序</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 mapreduce]$ hadoop jar /opt/module/hadoop-2.7.2/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.2.jar testmapredsort -sortInput random-data -sortOutput sorted-data</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
</li>
</ol>
<h3 id="HDFS参数调优"><a href="#HDFS参数调优" class="headerlink" title="HDFS参数调优"></a>HDFS参数调优</h3><ul>
<li>位于hdfs-site.xml</li>
</ul>
<ol>
<li>dfs.namenode.handler.count<ul>
<li>NameNode有一个工作线程池，用来处理不同的DataNode的并发心跳以及客户端并发的元数据操作。</li>
<li>通常取 20 × log2(Cluster Size)，Cluster Size为集群规模。</li>
</ul>
</li>
<li>编辑日志存储路径dfs.namenode.edits.dir 设置与镜像文件存储路径dfs.namenode.name.dir尽量分开，达到最低写入延迟</li>
</ol>
<h2 id="安装Zookeeper"><a href="#安装Zookeeper" class="headerlink" title="安装Zookeeper"></a>安装Zookeeper</h2><ol>
<li>上传tar包到服务器</li>
<li>解压到 module</li>
<li>配置<ul>
<li>软件目录下mkdir zkData</li>
<li>创建文件myid</li>
<li>编辑2</li>
<li>进入conf文件</li>
<li>重命名zoo_sample.cfg为zoo.cfg</li>
<li>进入编辑dataDir 和 添加集群</li>
<li>分发</li>
<li>改myid</li>
<li>启动bin/zkServer.sh start</li>
<li>半数机制即著名的选举机制，选取节点数</li>
</ul>
</li>
</ol>
<h2 id="Flume"><a href="#Flume" class="headerlink" title="Flume"></a>Flume</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li><p>上传</p>
</li>
<li><p>解压</p>
</li>
<li><p>配置</p>
<p>env java_home</p>
</li>
<li><p>分发</p>
</li>
</ul>
<h3 id="测试监控"><a href="#测试监控" class="headerlink" title="测试监控"></a>测试监控</h3><table>
<thead>
<tr>
<th>字段（图表名称）</th>
<th>字段含义</th>
</tr>
</thead>
<tbody><tr>
<td>EventPutAttemptCount</td>
<td>source尝试写入channel的事件总数量</td>
</tr>
<tr>
<td>EventPutSuccessCount</td>
<td>成功写入channel且提交的事件总数量</td>
</tr>
<tr>
<td>EventTakeAttemptCount</td>
<td>sink尝试从channel拉取事件的总数量。这不意味着每次事件都被返回，因为sink拉取的时候channel可能没有任何数据。</td>
</tr>
<tr>
<td>EventTakeSuccessCount</td>
<td>sink成功读取的事件的总数量</td>
</tr>
<tr>
<td>StartTime</td>
<td>channel启动的时间（毫秒）</td>
</tr>
<tr>
<td>StopTime</td>
<td>channel停止的时间（毫秒）</td>
</tr>
<tr>
<td>ChannelSize</td>
<td>目前channel中事件的总数量</td>
</tr>
<tr>
<td>ChannelFillPercentage</td>
<td>channel占用百分比</td>
</tr>
<tr>
<td>ChannelCapacity</td>
<td>channel的容量</td>
</tr>
</tbody></table>
<p>若 EventPutAttemptCount总大于EventTakeAttemptCount，说明总有失败，集群不稳定</p>
<p>方案：增加flume函数或者增加flume内存</p>
<h3 id="Flume组件"><a href="#Flume组件" class="headerlink" title="Flume组件"></a>Flume组件</h3><h4 id="流式结构"><a href="#流式结构" class="headerlink" title="流式结构"></a>流式结构</h4><h4 id><a href="#" class="headerlink" title></a><a href="https://user-gold-cdn.xitu.io/2018/11/9/166f61f91e1a1378?imageslim" target="_blank" rel="noopener" data-fancybox="group" data-caption="img" class="fancybox"><img alt="img" title="img" data-src="https://user-gold-cdn.xitu.io/2018/11/9/166f61f91e1a1378?imageslim" class="lazyload"></a></h4><h4 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h4><ol>
<li><p>TailDir Source</p>
<p>断点续传，多目录</p>
</li>
<li><p>Exec Source</p>
<p>实时搜集数据，但是在Flume不运行或者Shell命令出错的情况下，数据将会丢失。</p>
</li>
<li><p>Spooling Directory Source</p>
<p>监控目录，不支持断点续传</p>
</li>
</ol>
<h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h4><ul>
<li>Kafka Channel，省区sink，提高效率</li>
</ul>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>在/opt/module/flume/conf目录下创建file-flume-kafka.conf文件</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 conf]$ vim file-flume-kafka.conf</span><br></pre></td></tr></table></figure></div>

<p>在文件配置如下内容</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang"></div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">a1.sources=r1</span><br><span class="line">a1.channels=c1 c2</span><br><span class="line"></span><br><span class="line"># <span class="selector-tag">configure</span> <span class="selector-tag">source</span></span><br><span class="line">a1.sources.r1.type = TAILDIR</span><br><span class="line">a1.sources.r1.positionFile = /opt/module/flume/test/log_position.json</span><br><span class="line">a1.sources.r1.filegroups = f1</span><br><span class="line">a1.sources.r1.filegroups.f1 = /tmp/logs/app.+</span><br><span class="line">a1.sources.r1.fileHeader = true</span><br><span class="line">a1.sources.r1.channels = c1 c2</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#interceptor</span></span><br><span class="line">a1.sources.r1.interceptors =  i1 i2</span><br><span class="line">a1.sources.r1.interceptors.i1.type = com.atguigu.flume.interceptor.LogETLInterceptor$Builder</span><br><span class="line">a1.sources.r1.interceptors.i2.type = com.atguigu.flume.interceptor.LogTypeInterceptor$Builder</span><br><span class="line"></span><br><span class="line">a1.sources.r1.selector.type = multiplexing</span><br><span class="line">a1.sources.r1.selector.header = topic</span><br><span class="line">a1.sources.r1.selector.mapping.topic_start = c1</span><br><span class="line">a1.sources.r1.selector.mapping.topic_event = c2</span><br><span class="line"></span><br><span class="line"># <span class="selector-tag">configure</span> <span class="selector-tag">channel</span></span><br><span class="line">a1.channels.c1.type = org.apache.flume.channel.kafka.KafkaChannel</span><br><span class="line">a1.channels.c1.kafka.bootstrap.servers = hadoop102:9092,hadoop103:9092,hadoop104:9092</span><br><span class="line">a1.channels.c1.kafka.topic = topic_start</span><br><span class="line">a1.channels.c1.parseAsFlumeEvent = false</span><br><span class="line">a1.channels.c1.kafka.consumer.group.id = flume-consumer</span><br><span class="line"></span><br><span class="line">a1.channels.c2.type = org.apache.flume.channel.kafka.KafkaChannel</span><br><span class="line">a1.channels.c2.kafka.bootstrap.servers = hadoop102:9092,hadoop103:9092,hadoop104:9092</span><br><span class="line">a1.channels.c2.kafka.topic = topic_event</span><br><span class="line">a1.channels.c2.parseAsFlumeEvent = false</span><br><span class="line">a1.channels.c2.kafka.consumer.group.id = flume-consumer</span><br></pre></td></tr></table></figure></div>

<p>分发到集群</p>
<h4 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h4><ol>
<li><p>创建Maven flume-interceptor</p>
</li>
<li><p>创建包名com.qiujie.flume.interceptor</p>
</li>
<li><p>pom.xml配置依赖</p>
</li>
<li><p>在com.qiujie.flume.interceptor下新建类</p>
</li>
<li><p>重写4个方法</p>
<ul>
<li>initialize()</li>
<li>intercept(Event event)</li>
<li>intercept(List<event> event)</event></li>
<li>close()</li>
</ul>
</li>
<li><p>Flume日志过滤工具类LogUtils</p>
</li>
<li><p>拦截器LogETLInterceptor</p>
</li>
<li><p>Flume日志类型区分拦截器LogTypeInterceptor</p>
</li>
<li><p>打包</p>
</li>
<li><p>后台运行</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent --name a1 --conf-file conf/file-flume-kafka.conf &amp;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>集群启动脚本</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">"start")&#123;</span><br><span class="line">        for i in hadoop102 hadoop103</span><br><span class="line">        do</span><br><span class="line">                echo " --------启动 $i 采集flume-------"</span><br><span class="line">                ssh $i "nohup /opt/module/flume/bin/flume-ng agent --conf-file /opt/module/flume/conf/file-flume-kafka.conf --name a1 -Dflume.root.logger=INFO,LOGFILE &gt;/dev/null 2&gt;&amp;1 &amp;"</span><br><span class="line">        done</span><br><span class="line">&#125;;;	</span><br><span class="line">"stop")&#123;</span><br><span class="line">        for i in hadoop102 hadoop103</span><br><span class="line">        do</span><br><span class="line">                echo " --------停止 $i 采集flume-------"</span><br><span class="line">                ssh $i "ps -ef | grep file-flume-kafka | grep -v grep |awk '&#123;print \$2&#125;' | xargs kill"</span><br><span class="line">        done</span><br><span class="line"></span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p>nohup：不挂起执行</p>
</li>
<li><p>&amp;：后台执行</p>
</li>
<li><p>/dev/null代表linux的空设备文件，所有往这个文件里面写入的内容都会丢失，俗称“黑洞”。</p>
</li>
<li><p>标准输入0：从键盘获得输入 /proc/self/fd/0 </p>
<p>标准输出1：输出到屏幕（即控制台） /proc/self/fd/1 </p>
<p>错误输出2：输出到屏幕（即控制台） /proc/self/fd/2</p>
</li>
</ul>
</li>
</ol>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang"></div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">示例日志（服务器时间戳 | 日志）：</span><br><span class="line">1540934156385|&#123;</span><br><span class="line">    "ap": "gmall", </span><br><span class="line">    "cm": &#123;</span><br><span class="line">        "uid": "1234", </span><br><span class="line">        "vc": "2", </span><br><span class="line">        "vn": "1.0", </span><br><span class="line">        "la": "EN", </span><br><span class="line">        "sr": "", </span><br><span class="line">        "os": "7.1.1", </span><br><span class="line">        "ar": "CN", </span><br><span class="line">        "md": "BBB100-1", </span><br><span class="line">        "ba": "blackberry", </span><br><span class="line">        "sv": "V2.2.1", </span><br><span class="line">        "g": "abc@gmail.com", </span><br><span class="line">        "hw": "1620x1080", </span><br><span class="line">        "t": "1506047606608", </span><br><span class="line">        "nw": "WIFI", </span><br><span class="line">        "ln": 0</span><br><span class="line">    &#125;, </span><br><span class="line">        "et": [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"ett"</span>: <span class="string">"1506047605364"</span>,  <span class="comment">//客户端事件产生时间</span></span><br><span class="line">                <span class="attr">"en"</span>: <span class="string">"display"</span>,  <span class="comment">//事件名称</span></span><br><span class="line">                <span class="attr">"kv"</span>: &#123;  <span class="comment">//事件结果，以key-value形式自行定义</span></span><br><span class="line">                    <span class="attr">"goodsid"</span>: <span class="string">"236"</span>,</span><br><span class="line">                    <span class="attr">"action"</span>: <span class="string">"1"</span>,</span><br><span class="line">                    <span class="attr">"extend1"</span>: <span class="string">"1"</span>,</span><br><span class="line"><span class="attr">"place"</span>: <span class="string">"2"</span>,</span><br><span class="line"><span class="attr">"category"</span>: <span class="string">"75"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,&#123;</span><br><span class="line">		        "ett": "1552352626835",</span><br><span class="line">		        "en": "active_background",</span><br><span class="line">		        "kv": &#123;</span><br><span class="line">			         "active_source": "1"</span><br><span class="line">		        &#125;</span><br><span class="line">	        &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><ul>
<li>解压完后重命名为kafka</li>
<li>目录下创建文件夹logs</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ol>
<li><p>vim config/server.properties</p>
</li>
<li><p>broker.id=0</p>
<p>broker的全局唯一编号，每个broker都不能重复</p>
</li>
<li><p>delete.topic.enable=true</p>
<p>删除topic使能</p>
</li>
<li><p>zookeeper.connect=hadoop102:2181,hadoop103:2181,hadoop104:2181</p>
<p>配置集群地址</p>
</li>
<li><p>配置环境变量</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">KAFKA_HOME</span></span><br><span class="line">export KAFKA_HOME=/opt/module/kafka</span><br><span class="line">export PATH=$PATH:$KAFKA_HOME/bin</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>分发kafka和配置集群的<strong>环境变量</strong></p>
</li>
<li><p>修改每个集群的broker.id见2</p>
</li>
<li><p>启动集群</p>
</li>
<li><p>关闭集群</p>
</li>
<li><p>集群脚本</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">"start")&#123;</span><br><span class="line">        for i in hadoop102 hadoop103 hadoop104</span><br><span class="line">        do</span><br><span class="line">                echo " --------启动 $i Kafka-------"</span><br><span class="line">                # 用于KafkaManager监控</span><br><span class="line">                ssh $i "export JMX_PORT=9988 &amp;&amp; /opt/module/kafka/bin/kafka-server-start.sh -daemon /opt/module/kafka/config/server.properties "</span><br><span class="line">        done</span><br><span class="line">&#125;;;</span><br><span class="line">"stop")&#123;</span><br><span class="line">        for i in hadoop102 hadoop103 hadoop104</span><br><span class="line">        do</span><br><span class="line">                echo " --------停止 $i Kafka-------"</span><br><span class="line">                ssh $i "/opt/module/kafka/bin/kafka-server-stop.sh stop"</span><br><span class="line">        done</span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure></div>

</li>
</ol>
<h3 id="Kafka-Manager"><a href="#Kafka-Manager" class="headerlink" title="Kafka Manager"></a>Kafka Manager</h3><ol>
<li><p>上传→解压</p>
</li>
<li><p>修改配置</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim application.conf</span><br><span class="line">修改为：</span><br><span class="line">kafka-manager.zkhosts="hadoop102:2181,hadoop103:2181,hadoop104:2181"</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>启动 （kafka-manager-1.3.3.22 目录下）</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup bin/kafka-manager   -Dhttp.port=7456 &gt;/opt/module/kafka-manager-1.3.3.22/start.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>打开<a href="http://hadoop102:7456" target="_blank" rel="noopener">http://hadoop102:7456</a></p>
</li>
<li><p>集群脚本</p>
</li>
<li><p>~/bin目录下</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim km.sh</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">"start")&#123;</span><br><span class="line">        echo " -------- 启动 KafkaManager -------"</span><br><span class="line">        nohup /opt/module/kafka-manager-1.3.3.22/bin/kafka-manager   -Dhttp.port=7456 &gt;start.log 2&gt;&amp;1 &amp;</span><br><span class="line">&#125;;;</span><br><span class="line">"stop")&#123;</span><br><span class="line">        echo " -------- 停止 KafkaManager -------"</span><br><span class="line">        ps -ef | grep ProdServerStart | grep -v grep |awk '&#123;print $2&#125;' | xargs kill </span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure></div>

</li>
</ol>
<h3 id="Kafka压力测试"><a href="#Kafka压力测试" class="headerlink" title="Kafka压力测试"></a>Kafka压力测试</h3><h4 id="Kafka压测"><a href="#Kafka压测" class="headerlink" title="Kafka压测"></a>Kafka压测</h4><p>用Kafka官方自带的脚本（位于kafka/bin）</p>
<p>kafka-consumer-perf-test.sh 消费测试</p>
<p>kafka-producer-perf-test.sh  生产测试</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">生产测试</span></span><br><span class="line">bin/kafka-producer-perf-test.sh  --topic test --record-size 100 --num-records 100000 --throughput 1000 --producer-props bootstrap.servers=hadoop102:9092,hadoop103:9092,hadoop104:9092</span><br><span class="line"><span class="meta">#</span><span class="bash">说明：record-size是一条信息有多大，单位是字节。num-records是总共发送多少条信息。throughput 是每秒多少条信息</span></span><br><span class="line"><span class="meta">#</span><span class="bash">输出</span></span><br><span class="line">5002 records sent, 1000.0 records/sec (0.10 MB/sec), 2.8 ms avg latency, 384.0 max latency.</span><br><span class="line">5005 records sent, 1001.0 records/sec (0.10 MB/sec), 3.2 ms avg latency, 110.0 max latency.</span><br><span class="line">5003 records sent, 1000.2 records/sec (0.10 MB/sec), 0.7 ms avg latency, 16.0 max latency.</span><br><span class="line">5000 records sent, 1000.0 records/sec (0.10 MB/sec), 0.7 ms avg latency, 14.0 max latency.</span><br><span class="line">5002 records sent, 1000.2 records/sec (0.10 MB/sec), 0.8 ms avg latency, 6.0 max latency.</span><br><span class="line">4999 records sent, 999.6 records/sec (0.10 MB/sec), 0.6 ms avg latency, 8.0 max latency.</span><br><span class="line">5006 records sent, 1001.0 records/sec (0.10 MB/sec), 2.7 ms avg latency, 139.0 max latency.</span><br><span class="line">100000 records sent, 999.410348 records/sec (0.10 MB/sec), 2.18 ms avg latency, 384.00 ms max latency, 1 ms 50th, 3 ms 95th, 50 ms 99th, 167 ms 99.9th.</span><br><span class="line">参数解析：本例中一共写入10w条消息，每秒向Kafka写入了0.10MB的数据，平均是1000条消息/秒，每次写入的平均延迟为2.18毫秒，最大的延迟为384毫秒。</span><br><span class="line"><span class="meta">#</span><span class="bash">消费测试</span></span><br><span class="line">bin/kafka-consumer-perf-test.sh --zookeeper hadoop102:2181 --topic test --fetch-size 10000 --messages 10000000 --threads 1</span><br><span class="line"><span class="meta">#</span><span class="bash">参数说明：</span></span><br><span class="line">--zookeeper 指定zookeeper的链接信息</span><br><span class="line">--topic 指定topic的名称</span><br><span class="line">--fetch-size 指定每次fetch的数据的大小</span><br><span class="line">--messages 总共要消费的消息个数</span><br><span class="line"><span class="meta">#</span><span class="bash">输出</span></span><br><span class="line">start.time, end.time, data.consumed.in.MB, MB.sec, data.consumed.in.nMsg, nMsg.sec</span><br><span class="line">2020-03-18 01:59:06:970, 2020-03-18 01:59:09:291, 9.5367, 4.1089, 100000, 43084.8772</span><br><span class="line">开始测试时间，测试结束数据，最大吞吐率9.5367MB/s，平均每秒消费4.1089MB/s，最大每秒消费100000条，平均每秒消费43084.8770条。</span><br></pre></td></tr></table></figure></div>

<h3 id="Kafka机器数量计算"><a href="#Kafka机器数量计算" class="headerlink" title="Kafka机器数量计算"></a>Kafka机器数量计算</h3><p>Kafka机器数量（经验公式）=2<em>（峰值生产速度</em>副本数/100）+1</p>
<h2 id="消费Kafka数据Flume"><a href="#消费Kafka数据Flume" class="headerlink" title="消费Kafka数据Flume"></a>消费Kafka数据Flume</h2><p><a href="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200318112034314.png" data-fancybox="group" data-caption="image-20200318112034314" class="fancybox"><img alt="image-20200318112034314" title="image-20200318112034314" data-src="https://qiujie219.gitee.io/myblog/img/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/image-20200318112034314.png" class="lazyload"></a></p>
<h3 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h3><ol>
<li><p>/opt/module/flume/conf</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kafka-flume-hdfs.conf</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang"></div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">## 组件</span><br><span class="line">a1.sources=r1 r2</span><br><span class="line">a1.channels=c1 c2</span><br><span class="line">a1.sinks=k1 k2</span><br><span class="line"></span><br><span class="line">## <span class="selector-tag">source1</span></span><br><span class="line">a1.sources.r1.type = org.apache.flume.source.kafka.KafkaSource</span><br><span class="line">a1.sources.r1.batchSize = 5000</span><br><span class="line">a1.sources.r1.batchDurationMillis = 2000</span><br><span class="line">a1.sources.r1.kafka.bootstrap.servers = hadoop102:9092,hadoop103:9092,hadoop104:9092</span><br><span class="line">a1.sources.r1.kafka.topics=topic_start</span><br><span class="line"></span><br><span class="line">## <span class="selector-tag">source2</span></span><br><span class="line">a1.sources.r2.type = org.apache.flume.source.kafka.KafkaSource</span><br><span class="line">a1.sources.r2.batchSize = 5000</span><br><span class="line">a1.sources.r2.batchDurationMillis = 2000</span><br><span class="line">a1.sources.r2.kafka.bootstrap.servers = hadoop102:9092,hadoop103:9092,hadoop104:9092</span><br><span class="line">a1.sources.r2.kafka.topics=topic_event</span><br><span class="line"></span><br><span class="line">## <span class="selector-tag">channel1</span></span><br><span class="line">a1.channels.c1.type = file</span><br><span class="line">a1.channels.c1.checkpointDir = /opt/module/flume/checkpoint/behavior1</span><br><span class="line">a1.channels.c1.dataDirs = /opt/module/flume/data/behavior1/</span><br><span class="line">a1.channels.c1.maxFileSize = 2146435071</span><br><span class="line">a1.channels.c1.capacity = 1000000</span><br><span class="line">a1.channels.c1.keep-alive = 6</span><br><span class="line"></span><br><span class="line">## <span class="selector-tag">channel2</span></span><br><span class="line">a1.channels.c2.type = file</span><br><span class="line">a1.channels.c2.checkpointDir = /opt/module/flume/checkpoint/behavior2</span><br><span class="line">a1.channels.c2.dataDirs = /opt/module/flume/data/behavior2/</span><br><span class="line">a1.channels.c2.maxFileSize = 2146435071</span><br><span class="line">a1.channels.c2.capacity = 1000000</span><br><span class="line">a1.channels.c2.keep-alive = 6</span><br><span class="line"></span><br><span class="line">## <span class="selector-tag">sink1</span></span><br><span class="line">a1.sinks.k1.type = hdfs</span><br><span class="line">a1.sinks.k1.hdfs.path = /origin_data/gmall/log/topic_start/%Y-%m-%d</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix = logstart-</span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = second</span><br><span class="line"></span><br><span class="line">#<span class="selector-id">#sink2</span></span><br><span class="line">a1.sinks.k2.type = hdfs</span><br><span class="line">a1.sinks.k2.hdfs.path = /origin_data/gmall/log/topic_event/%Y-%m-%d</span><br><span class="line">a1.sinks.k2.hdfs.filePrefix = logevent-</span><br><span class="line">a1.sinks.k2.hdfs.round = true</span><br><span class="line">a1.sinks.k2.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k2.hdfs.roundUnit = second</span><br><span class="line"></span><br><span class="line">## 不要产生大量小文件</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 10</span><br><span class="line">a1.sinks.k1.hdfs.rollSize = 134217728</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 0</span><br><span class="line"></span><br><span class="line">a1.sinks.k2.hdfs.rollInterval = 10</span><br><span class="line">a1.sinks.k2.hdfs.rollSize = 134217728</span><br><span class="line">a1.sinks.k2.hdfs.rollCount = 0</span><br><span class="line"></span><br><span class="line">## 控制输出文件是原生文件。</span><br><span class="line">a1.sinks.k1.hdfs.fileType = CompressedStream </span><br><span class="line">a1.sinks.k2.hdfs.fileType = CompressedStream </span><br><span class="line"></span><br><span class="line">a1.sinks.k1.hdfs.codeC = lzop</span><br><span class="line">a1.sinks.k2.hdfs.codeC = lzop</span><br><span class="line"></span><br><span class="line">## 拼装</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel= c1</span><br><span class="line"></span><br><span class="line">a1.sources.r2.channels = c2</span><br><span class="line">a1.sinks.k2.channel= c2</span><br></pre></td></tr></table></figure></div>

</li>
</ol>
<h3 id="日志消费Flume启动停止脚本"><a href="#日志消费Flume启动停止脚本" class="headerlink" title="日志消费Flume启动停止脚本"></a>日志消费Flume启动停止脚本</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">"start")&#123;</span><br><span class="line">        for i in hadoop104</span><br><span class="line">        do</span><br><span class="line">                echo " --------启动 $i 消费flume-------"</span><br><span class="line">                ssh $i "nohup /opt/module/flume/bin/flume-ng agent --conf-file /opt/module/flume/conf/kafka-flume-hdfs.conf --name a1 -Dflume.root.logger=INFO,LOGFILE &gt;/opt/module/flume/log.txt   2&gt;&amp;1 &amp;"</span><br><span class="line">        done</span><br><span class="line">&#125;;;</span><br><span class="line">"stop")&#123;</span><br><span class="line">        for i in hadoop104</span><br><span class="line">        do</span><br><span class="line">                echo " --------停止 $i 消费flume-------"</span><br><span class="line">                ssh $i "ps -ef | grep kafka-flume-hdfs | grep -v grep |awk '&#123;print \$2&#125;' | xargs kill"</span><br><span class="line">        done</span><br><span class="line"></span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure></div>

<h3 id="采集通道启动-停止脚本"><a href="#采集通道启动-停止脚本" class="headerlink" title="采集通道启动/停止脚本"></a>采集通道启动/停止脚本</h3><p>~/bin</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim cluster.sh</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/bash</span></span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">"start")&#123;</span><br><span class="line">	echo " -------- 启动 集群 -------"</span><br><span class="line"></span><br><span class="line">	echo " -------- 启动 hadoop集群 -------"</span><br><span class="line">	/opt/module/hadoop-2.7.2/sbin/start-dfs.sh </span><br><span class="line">	ssh hadoop103 "/opt/module/hadoop-2.7.2/sbin/start-yarn.sh"</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span><span class="bash">启动 Zookeeper集群</span></span><br><span class="line">	zk.sh start</span><br><span class="line"></span><br><span class="line">sleep 4s;</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span><span class="bash">启动 Flume采集集群</span></span><br><span class="line">	f1.sh start</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span><span class="bash">启动 Kafka采集集群</span></span><br><span class="line">	kf.sh start</span><br><span class="line"></span><br><span class="line">sleep 6s;</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span><span class="bash">启动 Flume消费集群</span></span><br><span class="line">	f2.sh start</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span><span class="bash">启动 KafkaManager</span></span><br><span class="line">	km.sh start</span><br><span class="line">&#125;;;</span><br><span class="line">"stop")&#123;</span><br><span class="line">    echo " -------- 停止 集群 -------"</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span><span class="bash">停止 KafkaManager</span></span><br><span class="line">	km.sh stop</span><br><span class="line"></span><br><span class="line">    #停止 Flume消费集群</span><br><span class="line">	f2.sh stop</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span><span class="bash">停止 Kafka采集集群</span></span><br><span class="line">	kf.sh stop</span><br><span class="line"></span><br><span class="line">    sleep 6s;</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span><span class="bash">停止 Flume采集集群</span></span><br><span class="line">	f1.sh stop</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span><span class="bash">停止 Zookeeper集群</span></span><br><span class="line">	zk.sh stop</span><br><span class="line"></span><br><span class="line">	echo " -------- 停止 hadoop集群 -------"</span><br><span class="line">	ssh hadoop103 "/opt/module/hadoop-2.7.2/sbin/stop-yarn.sh"</span><br><span class="line">	/opt/module/hadoop-2.7.2/sbin/stop-dfs.sh </span><br><span class="line">&#125;;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure></div>



<h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><h3 id="hadoop启动后没有datanode"><a href="#hadoop启动后没有datanode" class="headerlink" title="hadoop启动后没有datanode"></a>hadoop启动后没有datanode</h3><ol>
<li>第一种解决办法</li>
</ol>
<ul>
<li><p>在第一次格式化dfs后，启动并使用了hadoop，后来又重新执行了格式化命令(hdfs namenode -format)，这时namenode的clusterID(从/opt/module/hadoop-2.7.2/data/tmp/dfs/name/current中查看)会重新生成，而datanode的clusterID(从/opt/module/hadoop-2.7.2/data/tmp/dfs/data/current中查看)依然保持不变</p>
</li>
<li><p>解决：只需要将namenode中的clusterID复制，覆盖到datanode中的clusterID即可</p>
<p>namenode的clusterID(从/opt/module/hadoop-2.7.2/data/tmp/dfs/name/current中查看)</p>
<p>datanode的clusterID(从/opt/module/hadoop-2.7.2/data/tmp/dfs/data/current中查看)</p>
</li>
</ul>
<ol start="2">
<li><p>如果第一种解决不成功</p>
<ul>
<li><p>杀进程（集群上所有主机）</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop-2.7.2]$ sbin/stop-all.sh</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>离开安全模式（所有主机）</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop-2.7.2]hdfs dfsadmin -safemode leave</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>删除所有的主机上的data和logs</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop-2.7.2]$ rm -r data/</span><br></pre></td></tr></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop-2.7.2]$ rm -r logs/</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>格式化</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop-2.7.2]$ hadoop namenode -format</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>重启hadoop</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop-2.7.2]$ sbin/start-all.sh</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
</li>
</ol>
<h3 id="namenode没启动"><a href="#namenode没启动" class="headerlink" title="namenode没启动"></a>namenode没启动</h3><ul>
<li><p>查看logs</p>
<p>没发现出来问题</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang"></div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NameNode: Clients are to use hadoop102:9000 to access this namenode/service.</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>尝试</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[qiujie@hadoop102 hadoop-2.7.2]$ sbin/refresh-namenodes.sh</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>报错</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">css</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">refreshNodes: Call From hadoop102/192.168.6.128 to hadoop102:9000 failed on connection exception: java.net.ConnectException: Connection refused; For more details see:  http://wiki.apache.org/hadoop/ConnectionRefused</span><br><span class="line"><span class="selector-tag">Error</span>: <span class="selector-tag">refresh</span> <span class="selector-tag">of</span> <span class="selector-tag">namenodes</span> <span class="selector-tag">failed</span>, <span class="selector-tag">see</span> <span class="selector-tag">error</span> <span class="selector-tag">messages</span> <span class="selector-tag">above</span>.</span><br></pre></td></tr></table></figure></div>

<p>连接主机错误</p>
</li>
<li><p>检查core-site.xml配置正确</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">2. ​    <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">3. ​    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://hadoop102:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">4. <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>于是开始思考之前的配置是否有出错，尝试把前面项目经验中的存储多目录的代码注释了，结果Hadoop正常启动。</p>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">球杰</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://qiujie219.gitee.io/myblog/2020/03/10/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/">https://qiujie219.gitee.io/myblog/2020/03/10/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98%E7%94%B5%E5%95%86%E6%95%B0%E4%BB%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://qiujie219.gitee.io/myblog">球杰の个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://qiujie219.gitee.io/myblog/img/大数据实战电商数仓/cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/myblog/img/wechat.png" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/myblog/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/myblog/2020/03/10/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93/"><img class="prev_cover lazyload" data-src="https://qiujie219.gitee.io/myblog/img/数据仓库/cover.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>数据仓库</span></div></a></div><div class="next-post pull_right"><a href="/myblog/2020/03/10/MySQL/"><img class="next_cover lazyload" data-src="https://qiujie219.gitee.io/myblog\img\MySQL\封面.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>MySQL</span></div></a></div></nav></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By 球杰</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/myblog/js/utils.js"></script><script src="/myblog/js/main.js"></script><script src="/myblog/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>